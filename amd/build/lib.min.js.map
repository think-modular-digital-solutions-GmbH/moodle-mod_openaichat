{"version":3,"file":"lib.min.js","sources":["../src/lib.js"],"sourcesContent":["define(['jquery', 'core/str'], ($, Str) => {\n\n    /* global assistantName, userName */\n\n    /* eslint-disable no-unused-vars */\n    let questionString = 'Ask a question...';\n    let errorString = 'An error occurred! Please try again later.';\n    /* eslint-enable no-unused-vars */\n\n    let chatData = {};\n\n    const init = (data) => {\n\n        const { modId, api_type, persistConvo, userId } = data;\n\n        // Load strings\n        Str.get_strings([\n            {key: 'askaquestion', component: 'mod_openaichat'},\n            {key: 'erroroccurred', component: 'mod_openaichat'},\n        ]).then(([q, e]) => {\n            questionString = q;\n            errorString = e;\n        });\n\n        if (api_type === 'assistant') {\n            initChatStorage(modId, persistConvo);\n        }\n\n        if (checkUserLimit(modId, userId) === false) {\n            disableButton();\n            return;\n        }\n\n        updateRemainingQuestions(modId, userId);\n\n        bindEvents(modId, api_type, userId);\n    };\n\n    /* ---------- helpers ---------- */\n\n    const initChatStorage = (modId, persistConvo) => {\n        chatData = JSON.parse(localStorage.getItem('mod_openaichat_data')) || {};\n\n        chatData[modId] = chatData[modId] || {};\n\n        if (chatData[modId].threadId && persistConvo === '1') {\n            fetch(`${M.cfg.wwwroot}/mod/openaichat/api/thread.php?modId=${modId}&thread_id=${chatData[modId].threadId}`)\n                .then(r => r.json())\n                .then(messages => {\n                    messages.forEach(m =>\n                        addToChatLog(m.role === 'user' ? 'user' : 'bot', m.message)\n                    );\n                })\n                .catch(() => {\n                    chatData[modId] = {};\n                    persistChat();\n                });\n        }\n\n        persistChat();\n    };\n\n    const persistChat = () => {\n        localStorage.setItem('mod_openaichat_data', JSON.stringify(chatData));\n    };\n\n    const bindEvents = (modId, api_type, userId) => {\n\n        const input = document.querySelector('#openai_input');\n\n        input.addEventListener('keyup', e => {\n            if (e.key === 'Enter' && input.value) {\n                handleSubmit(input.value, modId, api_type, userId);\n                input.value = '';\n            }\n        });\n\n        document.querySelector('.mod_openaichat #go')\n            .addEventListener('click', () => {\n                if (input.value) {\n                    handleSubmit(input.value, modId, api_type, userId);\n                    input.value = '';\n                }\n            });\n\n        document.querySelector('.mod_openaichat #refresh')\n            .addEventListener('click', () => clearHistory(modId));\n    };\n\n    const handleSubmit = (message, modId, api_type, userId) => {\n        if (checkUserLimit(modId, userId) === false) {\n            disableButton();\n            return;\n        }\n\n        addToChatLog('user', message);\n        createCompletion(message, modId, api_type, userId);\n    };\n\n    const updateRemainingQuestions = (modId, userId) => {\n        const remaining = checkUserLimit(modId, userId);\n        if (remaining !== -1) {\n            document.querySelector('#remaining-questions').innerText =\n                `You have ${remaining} question(s) remaining.`;\n        }\n    };\n\n    const addToChatLog = (type, message) => {\n        const container = document.querySelector('#openai_chat_log');\n\n        const el = document.createElement('div');\n        el.classList.add('openai_message', ...type.split(' '));\n\n        const span = document.createElement('span');\n        span.innerHTML = message;\n\n        el.append(span);\n        container.append(el);\n\n        if (span.offsetWidth) {\n            el.style.width = `${span.offsetWidth + 40}px`;\n        }\n\n        container.scrollTop = container.scrollHeight;\n    };\n\n    const clearHistory = (modId) => {\n        chatData[modId] = {};\n        persistChat();\n        document.querySelector('#openai_chat_log').innerHTML = '';\n    };\n\n    const createCompletion = (message, modId, api_type, userId) => {\n\n        let threadId = null;\n\n        if (api_type === 'assistant') {\n            threadId = chatData?.[modId]?.threadId || null;\n        }\n\n        const history = buildTranscript();\n\n        toggleControls(true);\n        addToChatLog('bot loading', '...');\n\n        fetch(`${M.cfg.wwwroot}/mod/openaichat/api/completion.php`, {\n            method: 'POST',\n            body: JSON.stringify({ message, history, modId, threadId })\n        })\n        .then(r => {\n            removeLastMessage();\n            toggleControls(false);\n            if (!r.ok) {\n                throw new Error(r.statusText);\n            }\n            return r.json();\n        })\n        .then(data => {\n            storeUserLog(modId, message, data.message);\n            addToChatLog('bot', data.message);\n\n            if (data.thread_id) {\n                chatData[modId].threadId = data.thread_id;\n                persistChat();\n            }\n\n            updateRemainingQuestions(modId, userId);\n            document.querySelector('#openai_input').focus();\n        })\n        .catch(() => {\n            const input = document.querySelector('#openai_input');\n            input.classList.add('error');\n            input.placeholder = errorString;\n        });\n    };\n\n    const buildTranscript = () => {\n        const transcript = [];\n        document.querySelectorAll('.openai_message').forEach((msg, i, all) => {\n            if (i === all.length - 1) {\n                return;\n            }\n            transcript.push({ user: msg.classList.contains('bot') ? assistantName : userName, message: msg.innerText });\n        });\n        return transcript;\n    };\n\n    const storeUserLog = (modId, requestMessage, responseMessage) => {\n        $.post(`${M.cfg.wwwroot}/mod/openaichat/api/record_log.php`, {\n            modId, requestMessage, responseMessage\n        });\n    };\n\n    const checkUserLimit = (modId, userId) => {\n        return $.ajax({\n            method: 'POST',\n            url: `${M.cfg.wwwroot}/mod/openaichat/api/question_counter.php`,\n            data: { modId, userId },\n            dataType: 'json',\n            async: false\n        }).responseJSON;\n    };\n\n    const toggleControls = (disabled) => {\n        document.querySelector('.mod_openaichat #control_bar')\n            .classList.toggle('disabled', disabled);\n    };\n\n    const removeLastMessage = () => {\n        const c = document.querySelector('#openai_chat_log');\n        if (c.lastElementChild) {\n            c.removeChild(c.lastElementChild);\n        }\n    };\n\n    const disableButton = () => {\n        const input = document.querySelector('#openai_input');\n        input.classList.add('error');\n        input.placeholder = 'Limit reached';\n        document.querySelector('.mod_openaichat #control_bar').classList.add('disabled');\n        document.querySelector('#remaining-questions').style.display = 'none';\n        return false;\n    };\n\n    return { init };\n});\n"],"names":["define","$","Str","questionString","errorString","chatData","initChatStorage","modId","persistConvo","JSON","parse","localStorage","getItem","threadId","fetch","M","cfg","wwwroot","then","r","json","messages","forEach","m","addToChatLog","role","message","catch","persistChat","setItem","stringify","bindEvents","api_type","userId","input","document","querySelector","addEventListener","e","key","value","handleSubmit","clearHistory","checkUserLimit","createCompletion","disableButton","updateRemainingQuestions","remaining","innerText","type","container","el","createElement","classList","add","split","span","innerHTML","append","offsetWidth","style","width","scrollTop","scrollHeight","history","buildTranscript","toggleControls","method","body","removeLastMessage","ok","Error","statusText","data","storeUserLog","thread_id","focus","placeholder","transcript","querySelectorAll","msg","i","all","length","push","user","contains","assistantName","userName","requestMessage","responseMessage","post","ajax","url","dataType","async","responseJSON","disabled","toggle","c","lastElementChild","removeChild","display","init","get_strings","component","_ref","q"],"mappings":"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"}
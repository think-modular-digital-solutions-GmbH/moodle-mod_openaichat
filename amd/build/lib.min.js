define("mod_openaichat/lib",["jquery","core/str"],(($,Str)=>{let questionString="Ask a question...",errorString="An error occurred! Please try again later.",chatData={};const initChatStorage=(modId,persistConvo)=>{chatData=JSON.parse(localStorage.getItem("mod_openaichat_data"))||{},chatData[modId]=chatData[modId]||{},chatData[modId].threadId&&"1"===persistConvo&&fetch("".concat(M.cfg.wwwroot,"/mod/openaichat/api/thread.php?modId=").concat(modId,"&thread_id=").concat(chatData[modId].threadId)).then((r=>r.json())).then((messages=>{messages.forEach((m=>addToChatLog("user"===m.role?"user":"bot",m.message)))})).catch((()=>{chatData[modId]={},persistChat()})),persistChat()},persistChat=()=>{localStorage.setItem("mod_openaichat_data",JSON.stringify(chatData))},bindEvents=(modId,api_type,userId)=>{const input=document.querySelector("#openai_input");input.addEventListener("keyup",(e=>{"Enter"===e.key&&input.value&&(handleSubmit(input.value,modId,api_type,userId),input.value="")})),document.querySelector(".mod_openaichat #go").addEventListener("click",(()=>{input.value&&(handleSubmit(input.value,modId,api_type,userId),input.value="")})),document.querySelector(".mod_openaichat #refresh").addEventListener("click",(()=>clearHistory(modId)))},handleSubmit=(message,modId,api_type,userId)=>{!1!==checkUserLimit(modId,userId)?(addToChatLog("user",message),createCompletion(message,modId,api_type,userId)):disableButton()},updateRemainingQuestions=(modId,userId)=>{const remaining=checkUserLimit(modId,userId);-1!==remaining&&(document.querySelector("#remaining-questions").innerText="You have ".concat(remaining," question(s) remaining."))},addToChatLog=(type,message)=>{const container=document.querySelector("#openai_chat_log"),el=document.createElement("div");el.classList.add("openai_message",...type.split(" "));const span=document.createElement("span");span.innerHTML=message,el.append(span),container.append(el),span.offsetWidth&&(el.style.width="".concat(span.offsetWidth+40,"px")),container.scrollTop=container.scrollHeight},clearHistory=modId=>{chatData[modId]={},persistChat(),document.querySelector("#openai_chat_log").innerHTML=""},createCompletion=(message,modId,api_type,userId)=>{let threadId=null;var _chatData,_chatData$modId;"assistant"===api_type&&(threadId=(null===(_chatData=chatData)||void 0===_chatData||null===(_chatData$modId=_chatData[modId])||void 0===_chatData$modId?void 0:_chatData$modId.threadId)||null);const history=buildTranscript();toggleControls(!0),addToChatLog("bot loading","...");let sesskey=M.cfg.sesskey;fetch("".concat(M.cfg.wwwroot,"/mod/openaichat/api/completion.php"),{method:"POST",body:JSON.stringify({sesskey:sesskey,message:message,history:history,modId:modId,threadId:threadId})}).then((r=>{if(removeLastMessage(),toggleControls(!1),!r.ok)throw new Error(r.statusText);return r.json()})).then((data=>{storeUserLog(modId,message,data.message),addToChatLog("bot",data.message),data.thread_id&&(chatData[modId].threadId=data.thread_id,persistChat()),updateRemainingQuestions(modId,userId),document.querySelector("#openai_input").focus()})).catch((()=>{const input=document.querySelector("#openai_input");input.classList.add("error"),input.placeholder=errorString}))},buildTranscript=()=>{const transcript=[];return document.querySelectorAll(".openai_message").forEach(((msg,i,all)=>{i!==all.length-1&&transcript.push({user:msg.classList.contains("bot")?assistantName:userName,message:msg.innerText})})),transcript},storeUserLog=(modId,requestMessage,responseMessage)=>{$.post("".concat(M.cfg.wwwroot,"/mod/openaichat/api/record_log.php"),{modId:modId,requestMessage:requestMessage,responseMessage:responseMessage})},checkUserLimit=(modId,userId)=>$.ajax({method:"POST",url:"".concat(M.cfg.wwwroot,"/mod/openaichat/api/question_counter.php"),data:{modId:modId,userId:userId},dataType:"json",async:!1}).responseJSON,toggleControls=disabled=>{document.querySelector(".mod_openaichat #control_bar").classList.toggle("disabled",disabled)},removeLastMessage=()=>{const c=document.querySelector("#openai_chat_log");c.lastElementChild&&c.removeChild(c.lastElementChild)},disableButton=()=>{const input=document.querySelector("#openai_input");return input.classList.add("error"),input.placeholder="Limit reached",document.querySelector(".mod_openaichat #control_bar").classList.add("disabled"),document.querySelector("#remaining-questions").style.display="none",!1};return{init:data=>{const{modId:modId,api_type:api_type,persistConvo:persistConvo,userId:userId}=data;Str.get_strings([{key:"askaquestion",component:"mod_openaichat"},{key:"erroroccurred",component:"mod_openaichat"}]).then((_ref=>{let[q,e]=_ref;questionString=q,errorString=e})),"assistant"===api_type&&initChatStorage(modId,persistConvo),!1!==checkUserLimit(modId,userId)?(updateRemainingQuestions(modId,userId),bindEvents(modId,api_type,userId)):disableButton()}}}));

//# sourceMappingURL=lib.min.js.map